---
title: "Analiza danych ankietowych"
author:
- Joanna Kusy
- Tomasz Srebniak
subtitle: Sprawozdanie 2
output:
  pdf_document:
    toc: true
    fig_caption: true
    fig_width: 5
    fig_height: 4
    number_sections: true
  html_document:
    toc: true
    df_print: paged
header-includes:
- \usepackage[OT4]{polski}
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
- \usepackage{float}
fontsize: 12pt
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
if (!require(knitr)) install.packages("knitr")
if (!require(readr)) install.packages("readr")
if (!require(latex2exp)) install.packages("latex2exp")
if (!require(dplyr)) install.packages("dplyr")
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(vctrs)) install.packages("vctrs")
if (!require(tidyr)) install.packages("tidyr")
if (!require(xtable)) install.packages("xtable")
library(binom)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
knitr::opts_chunk$set(fig.pos = "H", out.extra = "", fig.align = "center")

```

\newpage

# Część I

## Zadanie 1

W ankiecie przedstawionej na poprzedniej liście pracownicy zostali poproszeni o wyrażenie opinii na temat skuteczności szkolenia "Efektywna komunikacja w zespole" zorganizowanego przez firmę.

Na podstawie odpowiedzi wyznaczono realizację przedziału ufności dla wektora prawdopodobieństw opisującego stopień zadowolenia ze szkolenia. Przyjęto poziom ufności $0.95$ oraz zastosowano poprawkę Bonferroniego.

Realizacja przedziału ufności dla wektora prawdopodobieństw wyznaczonego metodą Cloppera–Pearsona.

```{r zad1_dane, echo=FALSE}
res <- c(14, 17, 40, 100, 29)
alpha <- 0.05
```

```{r zad1_exact}
ci_exact <- binom.confint(res, 200, 1 - alpha/5, method='exact')
ci_exact$len <- ci_exact$upper - ci_exact$lower
```

```{r zad1_exact_res, echo=FALSE}
ci_exact
```

Realizacja przedziału ufności dla wektora prawdopodobieństw wyznaczonego metodą Wilsona.

```{r zad1_wilson, echo=FALSE}
ci_wilson <-binom.confint(res, 200, 1 - alpha/5, method='wilson')
ci_wilson$len <- ci_wilson$upper - ci_wilson$lower
ci_wilson
```

Realizacja przedziału ufności dla wektora prawdopodobieństw wyznaczonego metodą asymptotyczną, opartą na Centralnym Twierdzeniu Granicznym.

```{r zad1_asymptotic, echo=FALSE}
ci_asymptotic <-binom.confint(res, 200, 1 - alpha/5, method='asymptotic')
ci_asymptotic$len <- ci_asymptotic$upper - ci_asymptotic$lower
ci_asymptotic
```

Dla zadanych kategorii otrzymujemy proporcje:

-   $0.070$ – odsetek osób bardzo niezadowolonych,

-   $0.085$ – odsetek osób niezadowolonych,

-   $0.200$ – odsetek osób nie mających zdania,

-   $0.500$ – odsetek osób zadowolonych,

-   $0.145$ – odsetek osób bardzo zadowolonych.

W zależności od wybranej metody, zmieniają się dolna i górna granica przedziału ufności. Dla kategorii z niewielką liczbą odpowiedzi (14 i 17 głosów) najwęższą realizację przedziału uzyskano przy zastosowaniu metody asymptotycznej. Wraz ze wzrostem liczby odpowiedzi (29 głosów), różnice w długości realizacji przedziałów wyznaczonych metodą asymptotyczną i metodą Wilsona stają się niewielkie. Dla kategorii, w których liczba odpowiedzi wynosiła 40 lub więcej, najwęższa realizacja przedziału została dzięki metodzie Wilsona. Metoda Cloppera–Pearsona nie dała najkrótszej realizacji przedziału dla żadnej z proporcji. Wynika to z faktu, że jest to metoda dokładna, która w sposób konserwatywny utrzymuje zadany poziom ufności.

## Zadanie 2

Napisano funkcję, która wyznacza wartość poziomu krytycznego w testach $\chi^2$ Pearsona oraz $\chi^2$ największej wiarogodności. Testy te służą do weryfikacji hipotezy $H_0: \mathbf{p} = \mathbf{p_0}$ przy hipotezie alternatywnej $H_1:\mathbf{p} \neq \mathbf{p_0}$ na podstawie obserwacji $\mathbf{x}$ wektora losowego $\mathbf{X}$ z rozkładu wielomianowego z parametrami $n$ i $\mathbf{p}$.

### Test $\chi^2$ Pearsona

Statystyką testową w teście jest $$
\chi^2 = \sum_{i=1}^k\frac{(X_i - np_{0i})^2}{np_{0i}},
$$ gdzie $p_{0i}$ jest i–tą składową wektora $\mathbf{p}$. \newline \newline Przy założeniu, że $H_0$ jest prawdziwa statystyka $\chi^2$ ma asymptotycznie rozkład $\chi^2$ z $k-1$ stopniami swobody. \newline

Wartość poziomu krytycznego liczymy jako $$
p–value=1-F_{\chi_{k-1}^2}(\chi^2(\mathbf{x})),
$$ gdzie $F_{\chi_{k-1}^2}$ jest dystrybuantą rozkładu $\chi^2$ z $k-1$ stopniami swobody, a $\chi^2(\mathbf{x})$ wartością statystki dla realizacji $\mathbf{x}$. \newline

### Test $\chi^2$ największej wiarogodności

Statystyką testową w teście IW jest $$
G^2 = 2\sum_{i=1}^kX_i\ln\bigg(\frac{X_i}{np_{0i}}\bigg)
$$ Przy założeniu, że $H_0$ jest prawdziwa statystyka $G^2$ ma asymptotycznie rozkład $\chi^2$ z $k-1$ stopniami swobody. \newline

Wartość poziomu krytycznego liczymy jako $$
p–value=1-F_{\chi_{k-1}^2}(G^2(\mathbf{x})),
$$ gdzie $F_{\chi_{k-1}^2}$ jest dystrybuantą rozkładu $\chi^2$ z $k-1$ stopniami swobody, a $G^2(\mathbf{x})$ wartością statystki dla realizacji $\mathbf{x}$. \newline

```{r testy_chi}
chi_sq_test <- function(x, p0, method='pearson') {
  if (method == 'pearson') {
    n <- sum(x)
    Chi2 <- sum((x - n * p0)^2 / (n * p0))
    p_val <- 1 - pchisq(Chi2, length(x) - 1)
    print(paste("p-value:", p_val))
  }
  if (method == 'IW') {
    n <- sum(x)
    G2 <- 2 * sum(x * log(x / (n * p0)))
    p_val <- 1 - pchisq(G2, length(x) - 1)
    print(paste("p-value:", p_val))
  }
}
```

Dla danych z poprzedniego zadania i $H_0: \mathbf{p} = (0.1, 0.2, 0.4, 0.2, 0.1)$ za pomocą funkcji otrzymamy następujące wartości poziomu krytycznego:

-   dla testu $\chi^2$ Pearsona

```{r chi2_pearson_res}
chi_sq_test(res, c(0.1, 0.2, 0.4, 0.2, 0.1), method='pearson')
```

-   dla testu $\chi^2$ największej wiarogodności

```{r chi2_likelihood_res}
chi_sq_test(res, c(0.1, 0.2, 0.4, 0.2, 0.1), method='IW')
```

Dla obu testów dla zadanego poziomu istotności $\alpha =0.05$ odrzucamy hipotezę zerową $H_0$ na rzecz hipotezy alternatywnej $H_1: \mathbf{p} \neq (0.1, 0.2, 0.4, 0.2, 0.1)$.

## Zadanie 3

Na podstawie danych z ankiety z poprzedniej listy zweryfikowano hipotezę, że w grupie pracowników zatrudnionwych w Dziale Produktowym rozkład odpowiedzi na pytanie "Jak bardzo zgadzasz się ze stwierdzeniem, że firma zapewnia odpowiednie wsparcie i materiały umożliwiające skuteczne wykorzystanie w praktyce wiedzy zdobytej w trakcie szkoleń?" jest równomierny. Przyjęto poziom istotności 0.05. Skorzystano z funkcji napisanej w zadaniu 2.

```{r zad3_setup, echo=FALSE}
ankieta <- read.csv('/Users/joannakusy/pwr/rok3/analiza_danych_ankietowych/Categorical_Data_Analysis/sprawozdanie1/ankieta.csv', header = TRUE, sep = ";", fileEncoding = "Latin2")
vec <- subset(ankieta, DZIAŁ == 'PD') %>% group_by(PYT_1) %>%
  summarise(n = n()) %>% select(n)
vec <- as.numeric(vec$n)
```

```{r zad3_pearson}
chi_sq_test(vec, rep(1/5, 5), method='pearson')  
```

```{r zad3_likelihood}
chi_sq_test(vec, rep(1/5, 5), method='IW')
```

Dla obu testów dla zadanego poziomu istotności $\alpha =0.05$ odrzucamy hipotezę o równomiernym rozkładzie odpowiedzi.

# Część II

## Zadanie 4

W pakiecie R do wykonania zarówno testu Fishera, jak i testu Freemana – Haltona, można posłużyć się funkcją *fisher.test* z biblioteki *stats*.

Przyjmuje ona następujące argumenty:

-   *x* -- dwuwymiarowa tabela kontyngencji w postaci macierzy lub obiektu typu factor,
-   *y = NULL* -- opcjonalny drugi obiekt typu factor. Używany tylko wtedy, gdy *x* nie jest macierzą,
-   *workspace = 200000* -- ilość pamięci roboczej w bajtach przeznaczonej na obliczenia (stosowane tylko dla tabel większych niż 2×2 przy podejściu dokładnym, bez symulacji p-value),
-   *hybrid = FALSE* -- wartość logiczna określająca, czy zastosować algorytm hybrydowy (dotyczy tylko tabel większych niż 2×2),
-   *hybridPars = c(expect = 5, percent = 80, Emin = 1)* -- wektor określający "warunki Cochrana" dla poprawności aproksymacji chi--kwadrat,
-   *control = list()* -- lista z nazwanymi komponentami do niskopoziomowej kontroli algorytmu,
-   *or = 1* -- wartość hipotetycznego ilorazu szans (stosowane wyłącznie dla tabel 2×2),
-   *alternative = "two.sided"* -- typ hipotezy alternatywnej ("two.sided", "less", "greater") – stosowane wyłącznie dla tabel 2×2,
-   *conf.int = TRUE* -- wartość logiczna wskazująca, czy obliczyć przedział ufności dla ilorazu szans (dotyczy tylko tabel 2×2),
-   *conf.level = 0.95* -- poziom ufności dla przedziału ufności ilorazu szans. Używana tylko przy tabelach o rozmiarach 2x2,
-   *simulate.p.value = FALSE* - -wartość logiczna określająca, czy *p-value* ma zostać oszacowane za pomocą symulacji Monte Carlo (dotyczy tylko tabel większych niż 2×2),
-   *B = 2000* -- liczba symulacji Monte Carlo.

Funkcja zwraca obiekt klasy *htest*, który zawiera następujące elementy:

-   *p.value* -- p wartość testu,
-   *conf.int* -- przedział ufności dla ilorazu szans (jeśli *conf.int = TRUE* i tabela ma rozmiar 2x2),
-   *estimate* -- estymowana wartość ilorazu szans (tylko dla tabel 2x2),
-   *null--value* -- wartość ilorazu szans podana w argumencie *or* (tylko dla tabel 2x2),
-   *alternative* -- typ hipotezy alternatywnej,
-   *method* -- napis "Fisher's Exact Test for Count Data",
-   *data.name* -- nazwa danych przekazanych do testu.

## Zadanie 5

Korzystając z testu Fishera, na poziomie istotności 0.05, zweryfikowano hipotezę o niezależności zmiennych **PŁEĆ** i **CZY_KIER**.

```{r zad5}
contingency_table <- table(ankieta$PŁEĆ, ankieta$CZY_KIER)
fisher.test(contingency_table, conf.level = 0.95)
```

P-value jest większe niż zadany poziom istotności, zatem nie mamy podstaw do odrzucenia hipotezy zerowej. Niezależność jest równoważne równości prawdopodobieństw warunkowych. Na poziomie istotności 0.05 możemy wnioskować, że prawdopodobieństwo tego, że na stanowisku kierowniczym pracuje kobieta jest równe prawdopodobieństwu tego, że na stanowisku kierowniczym pracuje mężczyzna.

## Zadanie 6

Korzystajac z testu Freemana-Haltona na poziomie istotności 0.05 zweryfikowano hipotezy dotyczące omawianych zmiennych.

### Podpunkt a

Zajmowanie stanowiska kierowniczego nie zależy od wieku.

```{r zad6_zmienne, echo=FALSE}
ankieta['WIEK_KAT'] <- ifelse(ankieta$WIEK < 36, 'młody', ifelse(ankieta$WIEK < 46, 'średni', ifelse(ankieta$WIEK < 56, 'starszy', 'emerytura')))
ankieta['CZY_ZADOW'] <- ifelse(ankieta$PYT_2 %in% c(1, 2), 'zadowolony', 'niezadowolony')
```

```{r zad6a}
t <- table(ankieta$CZY_KIER, ankieta$WIEK_KAT)
fisher.test(t, conf.level = 0.95) 
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Zajmowanie stanowiska kierowniczego i wiek są zmiennymi niezależnymi.

### Podpunkt b

Zajmowanie stanowiska kierowniczego nie zależy od stażu pracy.

```{r zad6b}
t <- table(ankieta$CZY_KIER, ankieta$STAŻ)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 odrzucucamy hipotezę zerową. Zmienne dotyczące zajmowania stanowiska kierowniczego oraz stażu pracy są zależne.

### Podpunkt c

Stopień zadowolenia ze szkoleń w kontekście dopasowania do indywidualnych potrzeb w pierwszym badanym okresie nie zależy od zajmowanego stanowiska.

Zmienne **PYT_2** oraz **CZY_KIER**.

```{r zad6c1}
t <- table(ankieta$PYT_2, ankieta$CZY_KIER)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 odrzucamy hipotezę zerową. Zajmowanie stanowiska kierowniczego i stopień zadowolenia ze szkoleń są zmiennymi zależnymi.

Zmienne **CZY_ZADOW** oraz **CZY_KIER**.

```{r zad6c2}
t <- table(ankieta$CZY_ZADOW, ankieta$CZY_KIER)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Zajmowanie stanowiska kierowniczego i stopień zadowolenia ze szkoleń są zmiennymi niezależnymi.

### Podpunkt d

Stopień zadowolenia ze szkoleń w kontekście dopasowania do indywidualnych potrzeb w pierwszym badanym okresie nie zależy od stażu.

Zmienne **PYT_2** oraz **STAŻ**.

```{r zad6d1}
t <- table(ankieta$PYT_2, ankieta$STAŻ)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 odrzucamy hipotezę zerową. Staż pracy i stopień zadowolenia ze szkoleń są zmiennymi zależnymi.

Zmienne **CZY_ZADOW** oraz **STAŻ**.

```{r zad6d2}
t <- table(ankieta$CZY_ZADOW, ankieta$STAŻ)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Staż pracy i stopień zadowolenia ze szkoleń są zmiennymi niezależnymi.

### Podpunkt e

Stopień zadowolenia ze szkoleń w kontekście dopasowania do indywidualnych potrzeb w pierwszym badanym okresie nie zależy od płci.

Zmienne **PYT_2** oraz **PŁEĆ**.

```{r zad6e1}
t <- table(ankieta$PYT_2, ankieta$PŁEĆ)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Płeć pracownika i stopień zadowolenia ze szkoleń są zmiennymi niezależnymi.

Zmienne **CZY_ZADOW** oraz **PŁEĆ**.

```{r zad6e2}
t <- table(ankieta$CZY_ZADOW, ankieta$PŁEĆ)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Płeć pracownika i stopień zadowolenia ze szkoleń są zmiennymi niezależnymi.

### Podpunkt f

Stopień zadowolenia ze szkoleń w kontekście dopasowania do indywidualnych potrzeb w pierwszym badanym okresie nie zależy od wieku.

Zmienne **PYT_2** oraz **WIEK_KAT**.

```{r zad6f1}
t <- table(ankieta$PYT_2, ankieta$WIEK_KAT)
fisher.test(t, conf.level = 0.95, workspace = 2e7)
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Wiek pracownika i stopień zadowolenia ze szkoleń są zmiennymi niezależnymi.

Zmienne **CZY_ZADOW** oraz **WIEK_KAT**.

```{r zad6f2}
t <- table(ankieta$CZY_ZADOW, ankieta$WIEK_KAT)
fisher.test(t, conf.level = 0.95)
```

Na poziomie istotności 0.05 nie mamy podstaw do odrzucenia hipotezy zerowej. Wiek pracownika i stopień zadowolenia ze szkoleń są zmiennymi niezależnymi.

### Porównanie wyników

W zależności od tego, czy do testowania hipotezy wykorzystaliśmy zmienną łączącą kategorie, czy też nie, w podpunktach c i d uzyskaliśmy różne wyniki. Natomiast w podpunktach e i f w obu przypadkach podjęliśmy decyzję o nieodrzuceniu hipotezy zerowej. We wszystkich omawianych przykładach *p--value* było większe przy wykorzystaniu zmiennej **CZY_ZADOW**.

# Część III

## Zadanie 7

Do wykonania testu niezależności Chi-kwadrat w R można użyć funkcji *chisq.test* z pakietu *stats*.

Funkcja ta przyjmuje następujące argumenty:

-   *x* – wektor lub macierz,

-   *y* – wektor, ignorowany, jeśli *x* jest macierzą,

-   *correct* – wartość logiczna określająca, czy zastosowana zostanie poprawka Yatesa,

-   *p* – wektor prawdopodobieństw,

-   *rescale.p* – wartość logiczna określająca, czy przeskalować wektor prawdopodobieństw tak, aby sumował się do 1,

-   *simulate.p.value* – wartość logiczna określająca, czy *p-value* oszacowane zostanie za pomocą symulacji Monte Carlo,

-   *B* – liczba symulacji Monte Carlo.

Funkcja zwraca obiekt klasy *htest*, który zawiera następujące elementy:

## Zadanie 8

## Zadanie 9

## Zadanie 10
